proto < ../../../shared/proto/user/user.proto

@host=http://selv.local:5001/backend
###
{{
    //pre request script
    exports.data = new TextEncoder().encode("test");
}}

GRPC /UsersService/ConnectUser
{
    "did": "did:key:z6MkfDvsiwx8ddaUitBuwxn8fCfyMZkK7ipQanMVS1FqvchE",
    "code": "a4e4aadf-90c7-4112-b00d-edb09496fc6e"
}
###
{{

const utils = require('../scripting/dist/bundle5.js');

const jwt = async () => {

    const { didDocument, keyPairs } = await utils.getDIDKey();
    const { id:did, authentication } = didDocument; 

    const header = {
        kid: `${authentication}`,
        alg: "EdDSA",
        typ: "JWT"
    }

    const encodedHeaders = Buffer.from(JSON.stringify(header), "utf8").toString("base64url");

    const claims = {
        "iss": did,
        "jti": "urn:uuid:3978344f-8596-4c3a-a978-8fcaba3903c5",
        "aud": "did:example:4a57546973436f6f6c4a4a57573",
        "nbf": Math.floor(Date.now() / 1000),
        "iat": Math.floor(Date.now() / 1000),
        "exp": Math.floor((Date.now() + 2 * (60 * 60 * 1000)) / 1000),
        "nonce": "343s$FSFDa-",
        "vp": {
            "@context": [
            "https://www.w3.org/2018/credentials/v1",
            "https://www.w3.org/2018/credentials/examples/v1"
            ],
            "type": [
            "VerifiablePresentation",
            "CredentialManagerPresentation"
            ],
            "verifiableCredential": [
                "eyJraWQiOiJkaWQ6aW90YTpybXM6MHgzZmJjNjVmMzg5ZTk2ZjI3MjZiOGY5YjZmNjNmNGUyZTYyYTc4YzQyMzhhMzgxYWUyNWJiOWQ3OGNmNDhjNGE1I0RmQnhlTTZrdnpvczc2VUlQWl9zNUhUQUJfNEM4bE5MRlZ3QlItczJtX1kiLCJ0eXAiOiJKV1QiLCJhbGciOiJFZERTQSJ9.eyJpc3MiOiJkaWQ6aW90YTpybXM6MHgzZmJjNjVmMzg5ZTk2ZjI3MjZiOGY5YjZmNjNmNGUyZTYyYTc4YzQyMzhhMzgxYWUyNWJiOWQ3OGNmNDhjNGE1IiwibmJmIjoxNTA4Njc1MDI4LCJzdWIiOiJkaWQ6andrOmV5SmhiR2NpT2lKRlpFUlRRU0lzSW1OeWRpSTZJa1ZrTWpVMU1Ua2lMQ0pyYVdRaU9pSmhjbmh6VEc1T1NXaEpZa1Z6WkdsQlpYVjROMlJ4YnpKaE0yTjZTRWRFWDJoU01VWllNV1U0UmpsQklpd2lhM1I1SWpvaVQwdFFJaXdpZUNJNklrbFliMDFUYkhSUk9UUnJWamRxYWtGa2VrVmZOSFZHU1dreU1DMXRhekpWV0hSeGVqbEljSGRSVWtraWZRIiwidmMiOnsiQGNvbnRleHQiOlsiaHR0cHM6Ly93d3cudzMub3JnLzIwMTgvY3JlZGVudGlhbHMvdjEiLCJodHRwczovL3d3dy53My5vcmcvMjAxOC9jcmVkZW50aWFscy9leGFtcGxlcy92MSJdLCJ0eXBlIjpbIlZlcmlmaWFibGVDcmVkZW50aWFsIiwiVW5pdmVyc2l0eURlZ3JlZUNyZWRlbnRpYWwiXSwiY3JlZGVudGlhbFN1YmplY3QiOnsiZGVncmVlIjp7Im5hbWUiOiJCYWNoZWxvciBvZiBTY2llbmNlIGFuZCBBcnRzIiwidHlwZSI6IkJhY2hlbG9yRGVncmVlIn19fX0.ljpZsaxd4JBap0y8ImaW6aOn_PRGfpckL2MIWKUMEuzGM2oX9MwmN10bMNU6szxLxcsAE3Gu37COwhiE8nvPBg"
            ]
        }
    }

    const encodedPayload = Buffer.from(JSON.stringify(claims), "utf8").toString("base64url");

    const encodedSignature = await utils.sign(`${encodedHeaders}.${encodedPayload}`)

    const jwt = `${encodedHeaders}.${encodedPayload}.${encodedSignature}`;
    return jwt;
}
exports.jwt = jwt();
}}

GRPC /UsersService/PresentCredential
{
    "user": {
        "did": "did:key:z6MkfDvsiwx8ddaUitBuwxn8fCfyMZkK7ipQanMVS1FqvchE",
        "code": "52c05d44-9020-40b5-9c6d-7109e2d94996"
    },
    "vp": "{{jwt}}"
}
###
{{
    //pre request script
    exports.data = new TextEncoder().encode("test");
}}

GRPC /UsersService/RequestCredential
{
    "user": {
        "did": "did:key:z6MkfDvsiwx8ddaUitBuwxn8fCfyMZkK7ipQanMVS1FqvchE",
        "code": "063bf112-5e45-4529-a085-fd91c79d8837"
    },
    "credentialDefinition": { 
        "type": [ "VerifiableCredential", "CitizenCredential" ]
    }
}