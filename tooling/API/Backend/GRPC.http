proto < ../../../shared/proto/user/user.proto

@host=http://selv.local:5001/backend
###
{{
    //pre request script
    exports.data = new TextEncoder().encode("test");
}}

GRPC /UsersService/ConnectUser
{
    "did": "did:key:z6MkfDvsiwx8ddaUitBuwxn8fCfyMZkK7ipQanMVS1FqvchE",
    "code": "3c9323c8-8691-4fb4-b406-43113592010d"
}
###
{{

const utils = require('../scripting/dist/bundle5.js');

const jwt = async () => {

    const { didDocument, keyPairs } = await utils.getDIDKey();
    const { id:did, authentication } = didDocument; 

    const header = {
        kid: `${authentication}`,
        alg: "EdDSA",
        typ: "JWT"
    }

    const encodedHeaders = Buffer.from(JSON.stringify(header), "utf8").toString("base64url");

    const claims = {
        "iss": did,
        "jti": "urn:uuid:3978344f-8596-4c3a-a978-8fcaba3903c5",
        "aud": "did:example:4a57546973436f6f6c4a4a57573",
        "nbf": Math.floor(Date.now() / 1000),
        "iat": Math.floor(Date.now() / 1000),
        "exp": Math.floor((Date.now() + 2 * (60 * 60 * 1000)) / 1000),
        "nonce": "343s$FSFDa-",
        "vp": {
            "@context": [
            "https://www.w3.org/2018/credentials/v1",
            "https://www.w3.org/2018/credentials/examples/v1"
            ],
            "type": [
            "VerifiablePresentation",
            "CredentialManagerPresentation"
            ],
            "verifiableCredential": [
                "eyJraWQiOiJkaWQ6aW90YTpybXM6MHgzZmJjNjVmMzg5ZTk2ZjI3MjZiOGY5YjZmNjNmNGUyZTYyYTc4YzQyMzhhMzgxYWUyNWJiOWQ3OGNmNDhjNGE1I0RmQnhlTTZrdnpvczc2VUlQWl9zNUhUQUJfNEM4bE5MRlZ3QlItczJtX1kiLCJ0eXAiOiJKV1QiLCJhbGciOiJFZERTQSJ9.eyJpc3MiOiJkaWQ6aW90YTpybXM6MHgzZmJjNjVmMzg5ZTk2ZjI3MjZiOGY5YjZmNjNmNGUyZTYyYTc4YzQyMzhhMzgxYWUyNWJiOWQ3OGNmNDhjNGE1IiwibmJmIjoxNTA4Njc1MDI4LCJzdWIiOiJkaWQ6a2V5Ono2TWtnaHdTU0xrSFhDd0hGRjlmTnpjeUJNY1ZBSzM4TERuUU14dDJFUTFha0FIZiIsInZjIjp7IkBjb250ZXh0IjpbImh0dHBzOi8vd3d3LnczLm9yZy8yMDE4L2NyZWRlbnRpYWxzL3YxIiwiaHR0cHM6Ly93d3cudzMub3JnLzIwMTgvY3JlZGVudGlhbHMvZXhhbXBsZXMvdjEiXSwidHlwZSI6WyJWZXJpZmlhYmxlQ3JlZGVudGlhbCIsIlVuaXZlcnNpdHlEZWdyZWVDcmVkZW50aWFsIl0sImNyZWRlbnRpYWxTdWJqZWN0Ijp7ImJpcnRocGxhY2UiOiJNdXN0ZXJzdGFkdCIsImNvdW50cnkiOiJHZXJtYW55IiwiZGF0ZSI6IkRhdGUubm93KCkiLCJmaXJzdE5hbWUiOiJCZW4iLCJsYXN0TmFtZSI6IlV0emVyIiwibmF0aW9uYWxpdHkiOiJnZXJtYW4iLCJwaG9uZSI6IjAwLTAwMDAifX19.BJuWfQH4lImRCb7GLKsSPTU46L9Asqs9PrymH-iPOnLBaoXMXO2V-Q4fgYouS2poJ1IyMjScX6f_BPe2tdHvBQ"
            ]
        }
    }

    const encodedPayload = Buffer.from(JSON.stringify(claims), "utf8").toString("base64url");

    const encodedSignature = await utils.sign(`${encodedHeaders}.${encodedPayload}`)

    const jwt = `${encodedHeaders}.${encodedPayload}.${encodedSignature}`;
    return jwt;
}
exports.jwt = jwt();
}}

GRPC /UsersService/PresentCredential
{
    "user": {
        "did": "did:key:z6MkfDvsiwx8ddaUitBuwxn8fCfyMZkK7ipQanMVS1FqvchE",
        "code": "08a8ef9f-da84-4e65-8e26-6d05a5cbe9bf"
    },
    "vp": "{{jwt}}"
}
###
{{
    //pre request script
    exports.data = new TextEncoder().encode("test");
}}

GRPC /UsersService/RequestCredential
{
    "user": {
        "did": "did:key:z6MkfDvsiwx8ddaUitBuwxn8fCfyMZkK7ipQanMVS1FqvchE",
        "code": "ae794ad5-7c88-4397-abb9-e5e0771aa97a"
    },
    "credentialDefinition": { 
        "type": [ "VerifiableCredential", "CitizenCredential" ]
    }
}